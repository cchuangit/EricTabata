<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Eric Tabata 計時器</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #ff6b6b;
            --rest-color: #1dd1a1;
            --warmup-color: #ff9f43;
            --cooldown-color: #54a0ff;
            --dark-bg: #1a1a2e;
            --card-bg: #16213e;
            --light-text: #f1f1f1;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
        }
        
        body {
            background-color: var(--dark-bg);
            color: var(--light-text);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            width: 100%;
            padding: 20px;
            flex: 1;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding-top: 10px;
        }
        
        h1 {
            font-size: 2.5rem;
            margin-bottom: 8px;
            background: linear-gradient(135deg, var(--primary-color), #ff8e8e);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .subtitle {
            color: #aaa;
            font-size: 1.1rem;
        }
        
        .card {
            background-color: var(--card-bg);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: var(--shadow);
            transition: transform 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
        }
        
        .section-title {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            font-size: 1.3rem;
        }
        
        .section-title i {
            margin-right: 10px;
            color: var(--primary-color);
        }
        
        .timer-display {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .time-left {
            font-size: 7rem;
            font-weight: 800;
            line-height: 1;
            margin: 20px 0;
            text-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            transition: color 0.5s ease;
        }
        
        .phase-label {
            font-size: 1.8rem;
            font-weight: 600;
            margin-bottom: 10px;
            padding: 10px 25px;
            border-radius: 50px;
            display: inline-block;
        }
        
        .work-phase { background-color: rgba(255, 107, 107, 0.2); color: var(--primary-color); }
        .rest-phase { background-color: rgba(29, 209, 161, 0.2); color: var(--rest-color); }
        .warmup-phase { background-color: rgba(255, 159, 67, 0.2); color: var(--warmup-color); }
        .cooldown-phase { background-color: rgba(84, 160, 255, 0.2); color: var(--cooldown-color); }
        
        .progress-info {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
            font-size: 1.1rem;
        }
        
        .progress-bar-container {
            height: 10px;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            margin: 25px 0;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color), #ff8e8e);
            border-radius: 5px;
            width: 0%;
            transition: width 1s linear;
        }
        
        .controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 30px 0;
        }
        
        .btn {
            padding: 18px 30px;
            border: none;
            border-radius: 15px;
            font-size: 1.2rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        
        .btn i {
            margin-right: 10px;
            font-size: 1.3rem;
        }
        
        .btn-start {
            background-color: var(--primary-color);
            color: white;
            flex: 1;
            max-width: 200px;
        }
        
        .btn-pause {
            background-color: #ff9f43;
            color: white;
        }
        
        .btn-reset {
            background-color: #6c5ce7;
            color: white;
        }
        
        .btn-settings {
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
        }
        
        .btn:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
        }
        
        .btn:active {
            transform: scale(0.98);
        }
        
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
        }
        
        .setting-group {
            margin-bottom: 20px;
        }
        
        .setting-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #ccc;
        }
        
        .setting-value {
            font-weight: 600;
            color: var(--primary-color);
            margin-left: 10px;
        }
        
        input[type="range"] {
            width: 100%;
            height: 10px;
            -webkit-appearance: none;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            outline: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--primary-color);
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        }
        
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 30px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.1);
            transition: .4s;
            border-radius: 34px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .toggle-slider {
            background-color: var(--primary-color);
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(30px);
        }
        
        .sound-options {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 15px;
        }
        
        .sound-option {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            cursor: pointer;
            transition: background-color 0.2s;
            flex: 1;
            min-width: 120px;
        }
        
        .sound-option:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .sound-option.active {
            background-color: rgba(255, 107, 107, 0.2);
            border: 2px solid var(--primary-color);
        }
        
        .sound-option i {
            margin-right: 10px;
            font-size: 1.2rem;
        }
        
        .preset-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 15px;
        }
        
        .preset-btn {
            padding: 12px 20px;
            background-color: rgba(255, 255, 255, 0.05);
            border: none;
            border-radius: 10px;
            color: white;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            flex: 1;
            min-width: 140px;
        }
        
        .preset-btn:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .preset-btn.active {
            background-color: var(--primary-color);
        }
        
        footer {
            text-align: center;
            margin-top: 40px;
            padding: 20px;
            color: #888;
            font-size: 0.9rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .hide {
            display: none !important;
        }
        
        .notification {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--primary-color);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            animation: slideUp 0.3s ease;
        }
        
        @keyframes slideUp {
            from { bottom: -50px; opacity: 0; }
            to { bottom: 20px; opacity: 1; }
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .time-left {
                font-size: 5rem;
            }
            
            .phase-label {
                font-size: 1.5rem;
            }
            
            .btn {
                padding: 15px 20px;
                font-size: 1.1rem;
            }
            
            .controls {
                flex-wrap: wrap;
            }
            
            .btn-start {
                min-width: 100%;
                order: 1;
            }
            
            .btn-pause, .btn-reset {
                flex: 1;
            }
        }
        
        @media (max-width: 480px) {
            .time-left {
                font-size: 4rem;
            }
            
            .settings-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* 為iOS Safari優化 */
        @supports (-webkit-touch-callout: none) {
            .btn, .sound-option, .preset-btn {
                -webkit-tap-highlight-color: transparent;
            }
            
            .time-left {
                font-weight: 900;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-stopwatch"></i>Eric Tabata 計時器</h1>
            <p class="subtitle">高強度間歇訓練計時器 - 專為運動員與新手設計</p>
        </header>
        
        <main>
            <!-- 計時器顯示區域 -->
            <div class="card timer-display">
                <div class="phase-label work-phase">準備開始</div>
                <div class="time-left" id="timeLeft">00:20</div>
                <div class="progress-info">
                    <div id="currentRound">輪數: 1/8</div>
                    <div id="currentSet">組數: 1/1</div>
                    <div id="totalTime">總時間: 4:00</div>
                </div>
                <div class="progress-bar-container">
                    <div class="progress-bar" id="progressBar"></div>
                </div>
            </div>
            
            <!-- 控制按鈕 -->
            <div class="controls">
                <button class="btn btn-start" id="startBtn">
                    <i class="fas fa-play"></i> 開始訓練
                </button>
                <button class="btn btn-pause hide" id="pauseBtn">
                    <i class="fas fa-pause"></i> 暫停
                </button>
                <button class="btn btn-reset" id="resetBtn">
                    <i class="fas fa-redo"></i> 重置
                </button>
                <button class="btn btn-settings" id="settingsBtn">
                    <i class="fas fa-cog"></i> 設定
                </button>
            </div>
            
            <!-- 設定面板 -->
            <div class="card" id="settingsPanel">
                <div class="section-title">
                    <i class="fas fa-sliders-h"></i> 訓練設定
                </div>
                
                <div class="settings-grid">
                    <!-- 基本設定 -->
                    <div class="setting-group">
                        <label class="setting-label">運動時間 (秒): <span class="setting-value" id="workTimeValue">20</span></label>
                        <input type="range" id="workTime" min="5" max="60" value="20" step="5">
                    </div>
                    
                    <div class="setting-group">
                        <label class="setting-label">休息時間 (秒): <span class="setting-value" id="restTimeValue">10</span></label>
                        <input type="range" id="restTime" min="5" max="60" value="10" step="5">
                    </div>
                    
                    <div class="setting-group">
                        <label class="setting-label">輪數: <span class="setting-value" id="roundsValue">8</span></label>
                        <input type="range" id="rounds" min="1" max="20" value="8">
                    </div>
                    
                    <div class="setting-group">
                        <label class="setting-label">組數: <span class="setting-value" id="setsValue">1</span></label>
                        <input type="range" id="sets" min="1" max="10" value="1">
                    </div>
                    
                    <!-- 進階設定 -->
                    <div class="setting-group">
                        <label class="setting-label">組間休息 (秒): <span class="setting-value" id="setRestValue">60</span></label>
                        <input type="range" id="setRest" min="0" max="180" value="60" step="10">
                    </div>
                    
                    <div class="setting-group">
                        <label class="setting-label">預備時間 (秒): <span class="setting-value" id="prepTimeValue">5</span></label>
                        <input type="range" id="prepTime" min="0" max="30" value="5">
                    </div>
                </div>
                
                <!-- 音效設定 -->
                <div class="section-title" style="margin-top: 30px;">
                    <i class="fas fa-volume-up"></i> 聲音提示
                </div>
                
                <div class="sound-options">
                    <div class="sound-option active" data-sound="beep">
                        <i class="fas fa-bell"></i> 提示音
                    </div>
                    <div class="sound-option" data-sound="voice">
                        <i class="fas fa-microphone"></i> 語音提示
                    </div>
                    <div class="sound-option" data-sound="both">
                        <i class="fas fa-bell"></i><i class="fas fa-microphone"></i> 兩者皆用
                    </div>
                    <div class="sound-option" data-sound="none">
                        <i class="fas fa-volume-mute"></i> 靜音
                    </div>
                </div>
                
                <!-- 熱身/緩和設定 -->
                <div class="section-title" style="margin-top: 30px;">
                    <i class="fas fa-fire-alt"></i> 熱身與緩和
                </div>
                
                <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
                    <div>
                        <label class="setting-label">熱身提醒</label>
                        <label class="toggle-switch">
                            <input type="checkbox" id="warmupToggle" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    
                    <div>
                        <label class="setting-label">緩和提醒</label>
                        <label class="toggle-switch">
                            <input type="checkbox" id="cooldownToggle" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
                
                <!-- 預設模式 -->
                <div class="section-title">
                    <i class="fas fa-star"></i> 預設模式
                </div>
                
                <div class="preset-buttons">
                    <button class="preset-btn active" data-preset="classic">
                        經典 Tabata (20/10 x 8)
                    </button>
                    <button class="preset-btn" data-preset="custom">
                        自訂訓練
                    </button>
                    <button class="preset-btn" data-preset="beginner">
                        新手模式 (15/15 x 6)
                    </button>
                    <button class="preset-btn" data-preset="advanced">
                        進階模式 (30/15 x 10)
                    </button>
                </div>
            </div>
        </main>
        
        <footer>
            <p>cch 專為 Vivian WU 設計的 Tabata 運動計時器 | 可添加到主螢幕離線使用</p>
        </footer>
    </div>
    
    <!-- 通知區域 -->
    <div id="notification" class="notification hide"></div>
    
    <!-- 音效 -->
    <audio id="beepSound" preload="auto">
        <source src="beep-02.mp3" type="audio/mpeg">
    </audio>
    
    <audio id="endSound" preload="auto">
        <source src="beep-25.mp3" type="audio/mpeg">
    </audio>

    <script>
        // 狀態管理
        const state = {
            isRunning: false,
            isPaused: false,
            currentPhase: 'prep', // prep, work, rest, setRest, warmup, cooldown
            currentTime: 0,
            currentRound: 1,
            currentSet: 1,
            totalRounds: 8,
            totalSets: 1,
            workTime: 20,
            restTime: 10,
            setRestTime: 60,
            prepTime: 5,
            warmupEnabled: true,
            cooldownEnabled: true,
            soundType: 'both', // beep, voice, both, none
            timerInterval: null,
            totalDuration: 0,
            timeElapsed: 0
        };
        
        // DOM 元素
        const timeLeftEl = document.getElementById('timeLeft');
        const currentRoundEl = document.getElementById('currentRound');
        const currentSetEl = document.getElementById('currentSet');
        const totalTimeEl = document.getElementById('totalTime');
        const progressBarEl = document.getElementById('progressBar');
        const phaseLabelEl = document.querySelector('.phase-label');
        
        const startBtn = document.getElementById('startBtn');
        const pauseBtn = document.getElementById('pauseBtn');
        const resetBtn = document.getElementById('resetBtn');
        const settingsBtn = document.getElementById('settingsBtn');
        const settingsPanel = document.getElementById('settingsPanel');
        
        const workTimeSlider = document.getElementById('workTime');
        const restTimeSlider = document.getElementById('restTime');
        const roundsSlider = document.getElementById('rounds');
        const setsSlider = document.getElementById('sets');
        const setRestSlider = document.getElementById('setRest');
        const prepTimeSlider = document.getElementById('prepTime');
        
        const workTimeValue = document.getElementById('workTimeValue');
        const restTimeValue = document.getElementById('restTimeValue');
        const roundsValue = document.getElementById('roundsValue');
        const setsValue = document.getElementById('setsValue');
        const setRestValue = document.getElementById('setRestValue');
        const prepTimeValue = document.getElementById('prepTimeValue');
        
        const warmupToggle = document.getElementById('warmupToggle');
        const cooldownToggle = document.getElementById('cooldownToggle');
        
        const soundOptions = document.querySelectorAll('.sound-option');
        const presetButtons = document.querySelectorAll('.preset-btn');
        
        const beepSound = document.getElementById('beepSound');
        const endSound = document.getElementById('endSound');
        const notificationEl = document.getElementById('notification');
        
        // 初始化應用程式
        function initApp() {
            // 從本地儲存載入設定
            loadSettings();
            
            // 更新顯示
            updateTimerDisplay();
            updateTotalTime();
            
            // 設定事件監聽器
            setupEventListeners();
            
            // 顯示歡迎訊息
            showNotification('Tabata計時器已就緒！調整設定後點擊「開始訓練」');
        }
        
        // 設定事件監聽器
        function setupEventListeners() {
            // 控制按鈕
            startBtn.addEventListener('click', startTimer);
            pauseBtn.addEventListener('click', pauseTimer);
            resetBtn.addEventListener('click', resetTimer);
            settingsBtn.addEventListener('click', toggleSettings);
            
            // 設定滑桿
            workTimeSlider.addEventListener('input', updateWorkTime);
            restTimeSlider.addEventListener('input', updateRestTime);
            roundsSlider.addEventListener('input', updateRounds);
            setsSlider.addEventListener('input', updateSets);
            setRestSlider.addEventListener('input', updateSetRest);
            prepTimeSlider.addEventListener('input', updatePrepTime);
            
            // 音效選擇
            soundOptions.forEach(option => {
                option.addEventListener('click', () => {
                    soundOptions.forEach(opt => opt.classList.remove('active'));
                    option.classList.add('active');
                    state.soundType = option.dataset.sound;
                    saveSettings();
                });
            });
            
            // 預設模式
            presetButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    presetButtons.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    applyPreset(btn.dataset.preset);
                });
            });
            
            // 熱身/緩和開關
            warmupToggle.addEventListener('change', () => {
                state.warmupEnabled = warmupToggle.checked;
                saveSettings();
                updateTotalTime();
            });
            
            cooldownToggle.addEventListener('change', () => {
                state.cooldownEnabled = cooldownToggle.checked;
                saveSettings();
                updateTotalTime();
            });
            
            // 防止iOS Safari縮放
            document.addEventListener('touchmove', (e) => {
                if(e.scale !== 1) {
                    e.preventDefault();
                }
            }, { passive: false });
        }
        
        // 開始計時器
        function startTimer() {
            if (state.isRunning && !state.isPaused) return;
            
            if (state.isPaused) {
                // 恢復計時
                state.isPaused = false;
                startBtn.classList.add('hide');
                pauseBtn.classList.remove('hide');
                startTimerInterval();
                showNotification('訓練繼續');
            } else {
                // 開始新訓練
                state.isRunning = true;
                state.isPaused = false;
                state.currentRound = 1;
                state.currentSet = 1;
                state.timeElapsed = 0;
                
                startBtn.classList.add('hide');
                pauseBtn.classList.remove('hide');
                
                // 如果有熱身，從熱身開始
                if (state.warmupEnabled) {
                    state.currentPhase = 'warmup';
                    state.currentTime = 30; // 30秒熱身
                    showNotification('熱身開始，準備好！');
                } else {
                    state.currentPhase = 'prep';
                    state.currentTime = state.prepTime;
                    showNotification('準備開始！');
                }
                
                updateTimerDisplay();
                startTimerInterval();
            }
        }
        
        // 暫停計時器
        function pauseTimer() {
            if (!state.isRunning) return;
            
            state.isPaused = true;
            clearInterval(state.timerInterval);
            startBtn.classList.remove('hide');
            pauseBtn.classList.add('hide');
            startBtn.innerHTML = '<i class="fas fa-play"></i> 繼續';
            showNotification('訓練已暫停');
        }
        
        // 重置計時器
        function resetTimer() {
            state.isRunning = false;
            state.isPaused = false;
            state.currentPhase = 'prep';
            state.currentTime = state.prepTime;
            state.currentRound = 1;
            state.currentSet = 1;
            state.timeElapsed = 0;
            
            clearInterval(state.timerInterval);
            
            startBtn.classList.remove('hide');
            pauseBtn.classList.add('hide');
            startBtn.innerHTML = '<i class="fas fa-play"></i> 開始訓練';
            
            updateTimerDisplay();
            updateTotalTime();
            showNotification('計時器已重置');
        }
        
        // 啟動計時器間隔
        function startTimerInterval() {
            clearInterval(state.timerInterval);
            
            state.timerInterval = setInterval(() => {
                state.currentTime--;
                state.timeElapsed++;
                
                // 更新進度條
                const progress = (state.timeElapsed / state.totalDuration) * 100;
                progressBarEl.style.width = `${progress}%`;
                
                // 檢查是否需要播放提示音
                if (state.currentTime <= 3 && state.currentTime > 0) {
                    playSound('countdown');
                }
                
                // 檢查當前階段是否結束
                if (state.currentTime <= 0) {
                    moveToNextPhase();
                }
                
                updateTimerDisplay();
            }, 1000);
        }
        
        // 移動到下一個階段
        function moveToNextPhase() {
            // 播放階段結束音效
            playSound('phaseEnd');
            
            switch (state.currentPhase) {
                case 'warmup':
                    state.currentPhase = 'prep';
                    state.currentTime = state.prepTime;
                    showNotification('準備開始運動！');
                    break;
                    
                case 'prep':
                    state.currentPhase = 'work';
                    state.currentTime = state.workTime;
                    showNotification(`第 ${state.currentRound} 輪運動開始！`);
                    break;
                    
                case 'work':
                    // 檢查是否是最後一輪的最後一組
                    if (state.currentRound === state.totalRounds && state.currentSet === state.totalSets) {
                        // 訓練結束
                        if (state.cooldownEnabled) {
                            state.currentPhase = 'cooldown';
                            state.currentTime = 60; // 60秒緩和
                            showNotification('訓練完成！開始緩和運動');
                        } else {
                            finishWorkout();
                            return;
                        }
                    } else if (state.currentRound === state.totalRounds) {
                        // 一組完成，進入組間休息
                        state.currentPhase = 'setRest';
                        state.currentTime = state.setRestTime;
                        state.currentRound = 1;
                        state.currentSet++;
                        showNotification(`第 ${state.currentSet-1} 組完成！組間休息`);
                    } else {
                        // 進入休息
                        state.currentPhase = 'rest';
                        state.currentTime = state.restTime;
                        state.currentRound++;
                        showNotification(`休息時間`);
                    }
                    break;
                    
                case 'rest':
                    state.currentPhase = 'work';
                    state.currentTime = state.workTime;
                    showNotification(`第 ${state.currentRound} 輪運動開始！`);
                    break;
                    
                case 'setRest':
                    state.currentPhase = 'work';
                    state.currentTime = state.workTime;
                    showNotification(`第 ${state.currentSet} 組，第 ${state.currentRound} 輪運動開始！`);
                    break;
                    
                case 'cooldown':
                    finishWorkout();
                    break;
                    
                default:
                    state.currentPhase = 'work';
                    state.currentTime = state.workTime;
            }
        }
        
        // 完成訓練
        function finishWorkout() {
            clearInterval(state.timerInterval);
            state.isRunning = false;
            state.isPaused = false;
            
            playSound('workoutEnd');
            
            // 顯示完成訊息
            phaseLabelEl.textContent = '訓練完成！';
            phaseLabelEl.className = 'phase-label cooldown-phase';
            timeLeftEl.textContent = '完成！';
            
            startBtn.classList.add('hide');
            pauseBtn.classList.add('hide');
            
            showNotification('恭喜！訓練完成！', 5000);
            
            // 5秒後重置
            setTimeout(() => {
                resetTimer();
            }, 5000);
        }
        
        // 更新計時器顯示
        function updateTimerDisplay() {
            // 格式化時間顯示
            const minutes = Math.floor(state.currentTime / 60);
            const seconds = state.currentTime % 60;
            timeLeftEl.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            // 更新階段標籤
            let phaseText = '';
            let phaseClass = '';
            
            switch (state.currentPhase) {
                case 'warmup':
                    phaseText = '熱身';
                    phaseClass = 'warmup-phase';
                    timeLeftEl.style.color = 'var(--warmup-color)';
                    break;
                case 'prep':
                    phaseText = '準備開始';
                    phaseClass = 'cooldown-phase';
                    timeLeftEl.style.color = 'var(--cooldown-color)';
                    break;
                case 'work':
                    phaseText = `運動 - 第 ${state.currentSet} 組，第 ${state.currentRound} 輪`;
                    phaseClass = 'work-phase';
                    timeLeftEl.style.color = 'var(--primary-color)';
                    break;
                case 'rest':
                    phaseText = `休息 - 第 ${state.currentSet} 組，第 ${state.currentRound} 輪`;
                    phaseClass = 'rest-phase';
                    timeLeftEl.style.color = 'var(--rest-color)';
                    break;
                case 'setRest':
                    phaseText = `組間休息 - 第 ${state.currentSet} 組`;
                    phaseClass = 'cooldown-phase';
                    timeLeftEl.style.color = 'var(--cooldown-color)';
                    break;
                case 'cooldown':
                    phaseText = '緩和運動';
                    phaseClass = 'cooldown-phase';
                    timeLeftEl.style.color = 'var(--cooldown-color)';
                    break;
            }
            
            phaseLabelEl.textContent = phaseText;
            phaseLabelEl.className = `phase-label ${phaseClass}`;
            
            // 更新輪數/組數顯示
            currentRoundEl.textContent = `輪數: ${state.currentRound}/${state.totalRounds}`;
            currentSetEl.textContent = `組數: ${state.currentSet}/${state.totalSets}`;
        }
        
        // 計算總時間
        function updateTotalTime() {
            // 計算總訓練時間（不包括熱身和緩和）
            let totalSeconds = 0;
            
            // 準備時間
            totalSeconds += state.prepTime;
            
            // 運動和休息時間
            const roundsPerSet = state.totalRounds;
            const totalRounds = state.totalRounds * state.totalSets;
            
            // 每輪有運動和休息（最後一輪只有運動）
            totalSeconds += totalRounds * state.workTime;
            totalSeconds += (totalRounds - state.totalSets) * state.restTime;
            
            // 組間休息（除了最後一組）
            totalSeconds += (state.totalSets - 1) * state.setRestTime;
            
            // 熱身和緩和
            if (state.warmupEnabled) totalSeconds += 30;
            if (state.cooldownEnabled) totalSeconds += 60;
            
            state.totalDuration = totalSeconds;
            
            // 更新顯示
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            totalTimeEl.textContent = `總時間: ${minutes}:${seconds.toString().padStart(2, '0')}`;
        }
        
        // 播放音效
        function playSound(type) {
            if (state.soundType === 'none') return;
            
            // 語音提示
            if (state.soundType === 'voice' || state.soundType === 'both') {
                speakPhaseInfo(type);
            }
            
            // 提示音
            if (state.soundType === 'beep' || state.soundType === 'both') {
                if (type === 'countdown') {
                    beepSound.currentTime = 0;
                    beepSound.play().catch(e => console.log("音效播放失敗:", e));
                } else if (type === 'phaseEnd' || type === 'workoutEnd') {
                    endSound.currentTime = 0;
                    endSound.play().catch(e => console.log("音效播放失敗:", e));
                }
            }
        }
        
        // 語音提示
        function speakPhaseInfo(type) {
            if (!('speechSynthesis' in window)) return;
            
            let speechText = '';
            
            if (type === 'countdown') {
                if (state.currentTime === 3) speechText = '3';
                else if (state.currentTime === 2) speechText = '2';
                else if (state.currentTime === 1) speechText = '1';
            } else if (type === 'phaseEnd') {
                switch (state.currentPhase) {
                    case 'work':
                        speechText = '休息';
                        break;
                    case 'rest':
                        speechText = '運動';
                        break;
                    case 'prep':
                        speechText = '開始運動';
                        break;
                    case 'setRest':
                        speechText = '組間休息結束，開始下一組';
                        break;
                    case 'warmup':
                        speechText = '熱身結束，準備開始';
                        break;
                }
            } else if (type === 'workoutEnd') {
                speechText = '訓練完成，恭喜！';
            }
            
            if (speechText) {
                const utterance = new SpeechSynthesisUtterance(speechText);
                utterance.lang = 'zh-TW';
                utterance.rate = 0.9;
                speechSynthesis.speak(utterance);
            }
        }
        
        // 切換設定面板顯示
        function toggleSettings() {
            settingsPanel.classList.toggle('hide');
            if (settingsPanel.classList.contains('hide')) {
                settingsBtn.innerHTML = '<i class="fas fa-cog"></i> 設定';
            } else {
                settingsBtn.innerHTML = '<i class="fas fa-times"></i> 關閉';
                updateTotalTime();
            }
        }
        
        // 更新運動時間
        function updateWorkTime() {
            state.workTime = parseInt(workTimeSlider.value);
            workTimeValue.textContent = state.workTime;
            saveSettings();
            updateTotalTime();
        }
        
        // 更新休息時間
        function updateRestTime() {
            state.restTime = parseInt(restTimeSlider.value);
            restTimeValue.textContent = state.restTime;
            saveSettings();
            updateTotalTime();
        }
        
        // 更新輪數
        function updateRounds() {
            state.totalRounds = parseInt(roundsSlider.value);
            roundsValue.textContent = state.totalRounds;
            saveSettings();
            updateTotalTime();
        }
        
        // 更新組數
        function updateSets() {
            state.totalSets = parseInt(setsSlider.value);
            setsValue.textContent = state.totalSets;
            saveSettings();
            updateTotalTime();
        }
        
        // 更新組間休息時間
        function updateSetRest() {
            state.setRestTime = parseInt(setRestSlider.value);
            setRestValue.textContent = state.setRestTime;
            saveSettings();
            updateTotalTime();
        }
        
        // 更新準備時間
        function updatePrepTime() {
            state.prepTime = parseInt(prepTimeSlider.value);
            prepTimeValue.textContent = state.prepTime;
            saveSettings();
            updateTotalTime();
        }
        
        // 應用預設模式
        function applyPreset(preset) {
            switch (preset) {
                case 'classic':
                    workTimeSlider.value = 20;
                    restTimeSlider.value = 10;
                    roundsSlider.value = 8;
                    setsSlider.value = 1;
                    setRestSlider.value = 60;
                    prepTimeSlider.value = 5;
                    break;
                case 'beginner':
                    workTimeSlider.value = 15;
                    restTimeSlider.value = 15;
                    roundsSlider.value = 6;
                    setsSlider.value = 1;
                    setRestSlider.value = 60;
                    prepTimeSlider.value = 10;
                    break;
                case 'advanced':
                    workTimeSlider.value = 30;
                    restTimeSlider.value = 15;
                    roundsSlider.value = 10;
                    setsSlider.value = 2;
                    setRestSlider.value = 90;
                    prepTimeSlider.value = 3;
                    break;
                case 'custom':
                    // 自訂模式不做更改
                    return;
            }
            
            // 更新狀態和顯示
            updateWorkTime();
            updateRestTime();
            updateRounds();
            updateSets();
            updateSetRest();
            updatePrepTime();
            
            // 如果不是自訂模式，重置計時器
            if (preset !== 'custom') {
                resetTimer();
            }
        }
        
        // 顯示通知
        function showNotification(message, duration = 3000) {
            notificationEl.textContent = message;
            notificationEl.classList.remove('hide');
            
            setTimeout(() => {
                notificationEl.classList.add('hide');
            }, duration);
        }
        
        // 儲存設定到本地儲存
        function saveSettings() {
            const settings = {
                workTime: state.workTime,
                restTime: state.restTime,
                totalRounds: state.totalRounds,
                totalSets: state.totalSets,
                setRestTime: state.setRestTime,
                prepTime: state.prepTime,
                warmupEnabled: state.warmupEnabled,
                cooldownEnabled: state.cooldownEnabled,
                soundType: state.soundType
            };
            
            localStorage.setItem('tabataSettings', JSON.stringify(settings));
        }
        
        // 從本地儲存載入設定
        function loadSettings() {
            const saved = localStorage.getItem('tabataSettings');
            
            if (saved) {
                const settings = JSON.parse(saved);
                
                state.workTime = settings.workTime || 20;
                state.restTime = settings.restTime || 10;
                state.totalRounds = settings.totalRounds || 8;
                state.totalSets = settings.totalSets || 1;
                state.setRestTime = settings.setRestTime || 60;
                state.prepTime = settings.prepTime || 5;
                state.warmupEnabled = settings.warmupEnabled !== undefined ? settings.warmupEnabled : true;
                state.cooldownEnabled = settings.cooldownEnabled !== undefined ? settings.cooldownEnabled : true;
                state.soundType = settings.soundType || 'beep';
                
                // 更新UI元素
                workTimeSlider.value = state.workTime;
                restTimeSlider.value = state.restTime;
                roundsSlider.value = state.totalRounds;
                setsSlider.value = state.totalSets;
                setRestSlider.value = state.setRestTime;
                prepTimeSlider.value = state.prepTime;
                warmupToggle.checked = state.warmupEnabled;
                cooldownToggle.checked = state.cooldownEnabled;
                
                // 更新音效選項
                soundOptions.forEach(option => {
                    option.classList.toggle('active', option.dataset.sound === state.soundType);
                });
            }
            
            // 更新顯示
            workTimeValue.textContent = state.workTime;
            restTimeValue.textContent = state.restTime;
            roundsValue.textContent = state.totalRounds;
            setsValue.textContent = state.totalSets;
            setRestValue.textContent = state.setRestTime;
            prepTimeValue.textContent = state.prepTime;
        }
        
        // 初始化應用程式
        document.addEventListener('DOMContentLoaded', initApp);
        
        // 為PWA添加到主螢幕做準備
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js').catch(error => {
                    console.log('Service Worker 註冊失敗:', error);
                });
            });
        }
    </script>
</body>
</html>